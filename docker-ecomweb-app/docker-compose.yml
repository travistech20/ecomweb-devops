
networks:
  ecomweb_internal_net:
    external: true 

services:

  # ecomweb_website:
  #   container_name: ecomweb_website_service
  #   image: ghcr.io/travistech20/ecomweb-website:latest
  #   env_file:
  #     - .env.website
  #   environment:
  #     - NODE_ENV=production
  #   ports:
  #     - '3003'
  #   restart: always
  #   networks:
  #     - travisbytes_net

  # ecomweb_storefront:
  #   container_name: ecomweb_storefront_service
  #   image: ghcr.io/travistech20/ecomweb-storefront:latest
  #   env_file:
  #     - .env.storefront
  #   environment:
  #     - NODE_ENV=production
  #   ports:
  #     - '3002'
  #   restart: always
  #   networks:
  #     - travisbytes_net

  # ecomweb_app:
  #   container_name: ecomweb_app_service
  #   image: ghcr.io/travistech20/ecomweb-web:latest
  #   env_file:
  #     - .env
  #   environment:
  #     - NODE_ENV=production
  #   ports:
  #     - '3000'
  #   restart: always
  #   networks:
  #     - travisbytes_net

  ecomweb_redis:
    image: redis:latest
    container_name: ecomweb-redis
    restart: always
    ports:
      - "6379"
    volumes:
      - redis-data:/data
    networks:
      - ecomweb_internal_net

  # API Service - Blue instance
  ecomweb_api_blue:
    container_name: ecomweb_api_blue
    image: ${API_BLUE_IMAGE}
    working_dir: /app
    command: [bash, /app/startup-api.sh]
    env_file:
      - .env.api
    environment:
      - NODE_ENV=production
      - SERVICE_COLOR=blue
      - SERVICE_TYPE=api
    ports:
      - '3001'
    depends_on:
      - ecomweb_redis
    restart: always
    volumes:
      - ./volumes/backend-api/ecosystem.api.config.js:/app/ecosystem.api.config.js
      - ./volumes/backend-api/startup-api.sh:/app/startup-api.sh
    networks:
      - ecomweb_internal_net
    # healthcheck:
    #   test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
    #   interval: 30s
    #   timeout: 20s
    #   retries: 3
    #   start_period: 40s

  # API Service - Green instance
  ecomweb_api_green:
    container_name: ecomweb_api_green
    image: ${API_GREEN_IMAGE}
    working_dir: /app
    command: [bash, /app/startup-api.sh]
    env_file:
      - .env.api
    environment:
      - NODE_ENV=production
      - SERVICE_COLOR=green
      - SERVICE_TYPE=api
    ports:
      - '3001'
    depends_on:
      - ecomweb_redis
    restart: always
    volumes:
      - ./volumes/backend-api/ecosystem.api.config.js:/app/ecosystem.api.config.js
      - ./volumes/backend-api/startup-api.sh:/app/startup-api.sh
    networks:
      - ecomweb_internal_net
    # healthcheck:
    #   test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
    #   interval: 30s
    #   timeout: 20s
    #   retries: 3
    #   start_period: 40s

  # Cron Worker Service - Runs scheduled tasks
  ecomweb_cron:
    container_name: ecomweb_cron
    image: ${API_BLUE_IMAGE}
    working_dir: /app
    command: [bash, /app/startup-cron.sh]
    env_file:
      - .env.api
    environment:
      - NODE_ENV=production
      - SERVICE_TYPE=cron
      - SHUTDOWN_GRACE_PERIOD=30
    depends_on:
      - ecomweb_redis
    restart: always
    volumes:
      - ./volumes/backend-api/ecosystem.cron.config.js:/app/ecosystem.cron.config.js
      - ./volumes/backend-api/startup-cron.sh:/app/startup-cron.sh
      - ./volumes/backend-api/graceful-shutdown.sh:/app/graceful-shutdown.sh
      - ./volumes/backend-api/healthcheck-cron.sh:/app/healthcheck-cron.sh
    networks:
      - ecomweb_internal_net
    # Graceful shutdown configuration
    stop_grace_period: 40s
    stop_signal: SIGTERM
    healthcheck:
      test: ["CMD", "bash", "/app/healthcheck-cron.sh"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s

  # Temporal Worker Service - Processes workflow tasks
  ecomweb_worker:
    container_name: ecomweb_worker
    image: ${API_BLUE_IMAGE}
    working_dir: /app
    command: [bash, /app/startup-worker.sh]
    env_file:
      - .env.api
    environment:
      - NODE_ENV=production
      - SERVICE_TYPE=worker
      - SHUTDOWN_GRACE_PERIOD=30
    depends_on:
      - ecomweb_redis
    restart: always
    volumes:
      - ./volumes/backend-api/ecosystem.worker.config.js:/app/ecosystem.worker.config.js
      - ./volumes/backend-api/startup-worker.sh:/app/startup-worker.sh
      - ./volumes/backend-api/graceful-shutdown.sh:/app/graceful-shutdown.sh
      - ./volumes/backend-api/healthcheck-worker.sh:/app/healthcheck-worker.sh
    networks:
      - ecomweb_internal_net
    # Graceful shutdown configuration
    stop_grace_period: 40s
    stop_signal: SIGTERM
    healthcheck:
      test: ["CMD", "bash", "/app/healthcheck-worker.sh"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s
    # Scale workers as needed
    deploy:
      replicas: 1          

volumes:
  redis-data: