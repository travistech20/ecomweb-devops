global
    log stdout local0
    # chroot /var/lib/haproxy
    stats socket /var/lib/haproxy/stats level admin mode 600
    user haproxy
    group haproxy
    daemon

    # Default SSL material locations
    ca-base /etc/ssl/certs
    crt-base /etc/ssl/private

    # Tune for better performance
    maxconn 4000
    tune.ssl.default-dh-param 2048

#---------------------------------------------------------------------
# Common defaults
#---------------------------------------------------------------------
defaults
    mode                    http
    log                     global
    option                  httplog
    option                  dontlognull
    option                  http-server-close
    option                  forwardfor       except 127.0.0.0/8
    option                  redispatch
    retries                 3
    timeout http-request    10s
    timeout queue           1m
    timeout connect         10s
    timeout client          1m
    timeout server          1m
    timeout http-keep-alive 10s
    timeout check           10s
    maxconn                 3000

#---------------------------------------------------------------------
# Statistics
#---------------------------------------------------------------------
stats enable
stats hide-version
stats refresh 30s
stats show-node
stats uri /stats

#---------------------------------------------------------------------
# Health check endpoint for HAProxy itself
#---------------------------------------------------------------------
frontend healthcheck
    bind *:80
    acl is_healthcheck path /haproxy-health
    # use_backend healthcheck_backend if is_healthcheck
    default_backend api_backend

# backend healthcheck_backend
    # errorfile 200 /etc/haproxy/errorfiles/200.http

#---------------------------------------------------------------------
# Main API backend
#---------------------------------------------------------------------
backend api_backend
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    
    # Blue server - initially enabled
    server blue ecomweb_api_blue:3001 check inter 2000 rise 2 fall 3 weight 100
    
    # Green server - initially disabled
    server green ecomweb_api_green:3001 check inter 2000 rise 2 fall 3 weight 0 disabled

    # Custom error pages
    # errorfile 503 /etc/haproxy/errorfiles/503.http
    
    # Add useful headers
    http-response set-header X-Server %s
    http-response set-header X-Backend-Color %[srv_name]

#---------------------------------------------------------------------
# WebSocket support
#---------------------------------------------------------------------
backend api_backend_ws
    balance roundrobin
    option http-server-close
    timeout tunnel 3600s
    
    # Same servers as API but for WebSocket
    server blue ecomweb_api_blue:3001 check inter 2000 rise 2 fall 3 weight 100
    server green ecomweb_api_green:3001 check inter 2000 rise 2 fall 3 weight 0 disabled

#---------------------------------------------------------------------
# Admin socket for runtime commands
#---------------------------------------------------------------------
listen stats
    bind :8404
    stats enable
    stats uri /
    stats hide-version
    # stats auth admin:haproxy123
